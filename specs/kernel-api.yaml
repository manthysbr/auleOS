openapi: 3.0.3
info:
  title: auleOS Kernel API
  version: 0.1.0
  description: API for the auleOS Kernel, allowing submitting jobs and streaming logs.

paths:
  /v1/jobs:
    post:
      summary: Submit a new Job (AWU)
      operationId: SubmitJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '201':
          description: Job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          description: Invalid job specification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      summary: List all jobs
      operationId: ListJobs
      responses:
        '200':
          description: List of jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Job'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /v1/jobs/{id}:
    get:
      summary: Get user job details
      operationId: GetJob
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
        description: Job ID
      responses:
        '200':
          description: Job Details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/jobs/{id}/stream:
    get:
      summary: Stream job logs and status updates (SSE)
      operationId: StreamJob
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
        description: Job ID
      responses:
        '200':
          description: Event stream
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  event: status
                  data: {"status": "RUNNING"}

                  event: log
                  data: {"line": "Compiling..."}
        '404':
          description: Job not found

  /v1/jobs/{id}/files/{filename}:
    get:
      summary: Serve a file directly from the job workspace
      operationId: ServeJobFile
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: filename
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: The file content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: File not found
        '500':
          description: Internal server error

  /v1/agent/chat:
    post:
      summary: Chat with the Agent
      operationId: AgentChat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Agent Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/conversations:
    get:
      summary: List all conversations
      operationId: ListConversations
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'
    post:
      summary: Create a new conversation
      operationId: CreateConversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  example: "New Chat"
      responses:
        '201':
          description: Conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'

  /v1/conversations/{id}:
    get:
      summary: Get conversation details
      operationId: GetConversation
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: Conversation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: Update conversation (e.g. title)
      operationId: UpdateConversation
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
      responses:
        '200':
          description: Updated conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
    delete:
      summary: Delete a conversation
      operationId: DeleteConversation
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '204':
          description: Deleted
        '404':
          description: Not found

  /v1/conversations/{id}/messages:
    get:
      summary: List messages in a conversation
      operationId: ListMessages
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      - in: query
        name: limit
        schema:
          type: integer
          default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'

  /v1/settings:
    get:
      summary: Get current settings (secrets masked)
      operationId: GetSettings
      responses:
        '200':
          description: Current application settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppConfig'
    put:
      summary: Update settings (encrypts secrets at rest)
      operationId: UpdateSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppConfig'
      responses:
        '200':
          description: Updated settings (secrets masked)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppConfig'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/settings/test:
    post:
      summary: Test provider connection
      operationId: TestConnection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - provider
              properties:
                provider:
                  type: string
                  enum: [ llm, image ]
      responses:
        '200':
          description: Connection test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionTestResult'

  /v1/projects:
    get:
      summary: List all projects
      operationId: ListProjects
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
    post:
      summary: Create a new project
      operationId: CreateProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - name
              properties:
                name:
                  type: string
                  example: "Campaign Q4"
                description:
                  type: string
                  example: "Marketing campaign assets"
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

  /v1/projects/{id}:
    get:
      summary: Get project details
      operationId: GetProject
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: Update project (name, description)
      operationId: UpdateProject
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Updated project
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete a project
      operationId: DeleteProject
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '204':
          description: Deleted
        '404':
          description: Not found

  /v1/projects/{id}/conversations:
    get:
      summary: List conversations in a project
      operationId: ListProjectConversations
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: List of conversations in the project
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'

  /v1/projects/{id}/artifacts:
    get:
      summary: List artifacts in a project
      operationId: ListProjectArtifacts
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: List of artifacts in the project
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Artifact'

  /v1/artifacts:
    get:
      summary: List all artifacts
      operationId: ListArtifacts
      parameters:
      - in: query
        name: type
        schema:
          type: string
          enum: [ image, text, document, audio, video, other ]
        description: Filter by artifact type
      responses:
        '200':
          description: List of artifacts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Artifact'

  /v1/artifacts/{id}:
    get:
      summary: Get artifact details
      operationId: GetArtifact
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: Artifact details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artifact'
        '404':
          description: Artifact not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete an artifact
      operationId: DeleteArtifact
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '204':
          description: Deleted
        '404':
          description: Not found

  /v1/personas:
    get:
      summary: List all personas
      operationId: ListPersonas
      responses:
        '200':
          description: List of personas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Persona'
    post:
      summary: Create a custom persona
      operationId: CreatePersona
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - name
              - system_prompt
              properties:
                name:
                  type: string
                  example: "Analyst"
                description:
                  type: string
                  example: "Data analysis specialist"
                system_prompt:
                  type: string
                  example: "You are a data analyst..."
                icon:
                  type: string
                  example: "bar-chart"
                color:
                  type: string
                  example: "cyan"
                allowed_tools:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Persona created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'

  /v1/personas/{id}:
    get:
      summary: Get persona details
      operationId: GetPersona
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '200':
          description: Persona details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'
        '404':
          description: Persona not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: Update persona
      operationId: UpdatePersona
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                system_prompt:
                  type: string
                icon:
                  type: string
                color:
                  type: string
                allowed_tools:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Updated persona
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'
        '404':
          description: Persona not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete a persona
      operationId: DeletePersona
      parameters:
      - in: path
        name: id
        schema:
          type: string
        required: true
      responses:
        '204':
          description: Deleted
        '404':
          description: Not found

components:
  schemas:
    ChatRequest:
      type: object
      required:
      - message
      properties:
        message:
          type: string
          example: "Run a python script that prints hello"
        model:
          type: string
          example: "llama3"
        conversation_id:
          type: string
          description: "Optional. If omitted, a new conversation is created automatically."
        persona_id:
          type: string
          description: "Optional persona ID to use for this chat. Sets the agent personality and tool filter."

    ChatResponse:
      type: object
      properties:
        response:
          type: string
        thought:
          type: string
          description: "Chain of thought or reasoning trace"
        conversation_id:
          type: string
          description: "The conversation this message belongs to"
        tool_call:
          type: object
          properties:
            name:
              type: string
            args:
              type: object
        steps:
          type: array
          items:
            $ref: '#/components/schemas/ReActStep'

    ReActStep:
      type: object
      properties:
        thought:
          type: string
        action:
          type: string
        action_input:
          type: object
          additionalProperties: true
        observation:
          type: string
        is_final_answer:
          type: boolean
        final_answer:
          type: string

    JobRequest:
      type: object
      required:
      - image
      - command
      properties:
        image:
          type: string
          example: "python:3.10-slim"
        command:
          type: array
          items:
            type: string
          example: [ "python", "-c", "print('Hello World')" ]
        env:
          type: object
          additionalProperties:
            type: string
        resources:
          $ref: '#/components/schemas/Resources'

    JobResponse:
      type: object
      properties:
        id:
          type: string
        status:
          type: string

    Job:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
        result:
          type: string
        error:
          type: string
        created_at:
          type: string
          format: date-time

    Resources:
      type: object
      properties:
        cpu:
          type: number
        memory_mb:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string

    Conversation:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        project_id:
          type: string
          description: "Optional project this conversation belongs to"
        persona_id:
          type: string
          description: "Optional persona used in this conversation"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        id:
          type: string
        conversation_id:
          type: string
        role:
          type: string
          enum: [ user, assistant, system, tool ]
        content:
          type: string
        thought:
          type: string
        steps:
          type: array
          items:
            $ref: '#/components/schemas/ReActStep'
        tool_call:
          type: object
          properties:
            name:
              type: string
            args:
              type: object
        created_at:
          type: string
          format: date-time

    ProviderConfig:
      type: object
      properties:
        mode:
          type: string
          enum: [ local, remote ]
          description: "'local' for Ollama/ComfyUI, 'remote' for OpenAI-compatible API"
        local_url:
          type: string
          example: "http://localhost:11434/v1"
        remote_url:
          type: string
          example: "https://api.openai.com/v1"
        api_key:
          type: string
          description: "Masked on read (****xxxx), plaintext on write. Empty string keeps existing."
        default_model:
          type: string
          example: "gemma3:12b"

    AppConfig:
      type: object
      properties:
        providers:
          type: object
          properties:
            llm:
              $ref: '#/components/schemas/ProviderConfig'
            image:
              $ref: '#/components/schemas/ProviderConfig'

    ConnectionTestResult:
      type: object
      properties:
        provider:
          type: string
        mode:
          type: string
        url:
          type: string
        model:
          type: string
        status:
          type: string
          enum: [ ok, error ]
        message:
          type: string

    Project:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Artifact:
      type: object
      properties:
        id:
          type: string
        project_id:
          type: string
        job_id:
          type: string
        conversation_id:
          type: string
        type:
          type: string
          enum: [ image, text, document, audio, video, other ]
        name:
          type: string
        file_path:
          type: string
        mime_type:
          type: string
        size_bytes:
          type: integer
          format: int64
        prompt:
          type: string
        created_at:
          type: string
          format: date-time

    Persona:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        system_prompt:
          type: string
        icon:
          type: string
          description: "Lucide icon name"
        color:
          type: string
          description: "Tailwind color token (e.g. blue, emerald, violet)"
        allowed_tools:
          type: array
          items:
            type: string
          description: "Tool names this persona can use. Empty means all tools."
        is_builtin:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
